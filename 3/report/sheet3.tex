% TEMPLATE.TEX
%
% Time-stamp: <2013-03-26 11:09 olenz>
%
% This is an extensively documented LaTeX file that shows how to
% produce a good-looking document with current LaTeX (11/2012).
%
% IMPORTANT!
%
%   Some obsolete commands and packages
% ----------|-------------------------------
% obsolete  |     Replacement in LATEX 2ε
% ----------|-------------------------------
%           | local            global/switch
% ----------|-------------------------------
% {\bf ...} | \textbf{...}     \bfseries
%     -     | \emph{...}       \em
% {\it ...} | \textit{...}     \itshape
%     -     | \textmd{...}     \mdseries
% {\rm ...} | \textrm{...}     \rmfamily
% {\sc ...} | \textsc{...}     \scshape
% {\sf ...} | \textsf{...}     \sffamily
% {\sl ...} | \textsl{...}     \slshape
% {\tt ...} | \texttt{...}     \ttfamily
%     -     | \textup{...}     \upshape
%
% DON'T USE \\ TO MAKE LINEBREAKS, INSTEAD JUST LEAVE A BLANK LINE!
%
\RequirePackage[l2tabu,orthodox]{nag} % turn on warnings because of bad style
\documentclass[a4paper,10pt,bibtotoc]{scrartcl}
%
\usepackage[bottom=3.5cm, top=3cm]{geometry}
\usepackage{subcaption}
\captionsetup[subfigure]{list=true, position=top}
\usepackage{float}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% KOMA CLASSES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% The class "scrartcl" is one of the so-called KOMA-classes, a set of
% very well done LaTeX-classes that produce a very European layout
% (e.g. titles with a sans-serif font).
%
% The KOMA classes have extensive documentation that you can access
% via the commands:
%   texdoc scrguide # in German
%   texdoc scrguien # in English
%
%
% The available classes are:
%
% scrartcl - for "articles", typically for up to ~20 pages, the
%            highest level sectioning command is \section
%
% scrreprt - for "reports", typically for up to ~200 pages, the
%            highest level sectioning command is \chapter
%
% scrbook  - for "books", for more than 200 pages, the highest level
%            sectioning command is \part.
%
% USEFUL OPTIONS
%
% a4paper  - Use a4 paper instead of the default american letter
%            format.
%
% 11pt, 12pt, 10pt
%          - Use a font with the given size.
%
% bibtotoc - Add the bibliography to the table of contents
%
% The KOMA-script classes have plenty of options to modify

% This allows to type UTF-8 characters like ä,ö,ü,ß
\usepackage[utf8]{inputenc}

\usepackage[T1]{fontenc}        % Tries to use Postscript Type 1 Fonts for better rendering
\usepackage{lmodern}            % Provides the Latin Modern Font which offers more glyphs than the default Computer Modern
\usepackage[intlimits]{amsmath} % Provides all mathematical commands
\usepackage{amssymb}
\usepackage{hyperref}           % Provides clickable links in the PDF-document for \ref
\usepackage{graphicx}            % Allow you to include images (like graphicx). Usage: \includegraphics{path/to/file}

% Allows to set units
\usepackage[ugly]{units}        % Allows you to type units with correct spacing and font style. Usage: $\unit[100]{m}$ or $\unitfrac[100]{m}{s}$

% Additional packages
\usepackage{url}                % Lets you typeset urls. Usage: \url{http://...}
\usepackage{breakurl}           % Enables linebreaks for urls
\usepackage{xspace}             % Use \xpsace in macros to automatically insert space based on context. Usage: \newcommand{\es}{ESPResSo\xspace}
\usepackage{xcolor}             % Obviously colors. Usage: \color{red} Red text
\usepackage{booktabs}           % Nice rules for tables. Usage \begin{tabular}\toprule ... \midrule ... \bottomrule
\usepackage{siunitx}


% Source code listings
\usepackage{listings}           % Source Code Listings. Usage: \begin{lstlisting}...\end{lstlisting}
\lstloadlanguages{python}
\definecolor{lightpurple}{rgb}{0.8,0.8,1}

\lstset{
stepnumber=1,
numbersep=5pt,
numberstyle=\small\color{black},
basicstyle=\ttfamily,
%keywordstyle=\color{black},
%commentstyle=\color{black},
%stringstyle=\color{black},
frame=single,
tabsize=4,
language = python,
backgroundcolor=\color{black!5}}

\usepackage{float}

\begin{document}

\titlehead{Simulation Methods in Physics I \hfill WS 2019/2010}
\title{Report for Worksheet 3: Molecular Dynamics 2 and Observables}
\author{Markus Baur and David Beyer}
\date{\today}
%\publishers{Institute for Computational Physics, University of Stuttgart}
\maketitle

\tableofcontents

\section{Saving and Restarting the Simulation}
\section{Simple Observables}
\begin{lstlisting}
def temperature(self):
    return 2 * self.e_kin() / (self.n_dims * self.n)
\end{lstlisting}
\begin{lstlisting}
def pressure(self):
    def ideal():
    return self.e_kin() * 2 / (self.n_dims * np.product(self.box))
    
    f = np.multiply(self.f_ij_matrix, self.r_ij_matrix)
    f = np.sum(f)

    area = np.product(self.box)
    ret = 1 / area * (self.e_kin() + f * 0.25)
    #print("Pressure: calculated=%4.6f, ideal=%4.6f" % (ret, ideal()))
    return ret
\end{lstlisting}


\section{Equilibration}
\section{Molecular Dynamics at a Desired Temperature}
The temperature $T(t)$ of the system at a given time $t$ is given by the equipartition theorem:
\begin{align}
T(t) = \frac{1}{k_\mathrm{B}DN}\sum_{i=1}^{N}\frac{m}{2}\mathbf{v}^2.
\end{align}
To reach the desired temperature $T_0$, we introduce rescaled velocities:
\begin{align}
\mathbf{v}\rightarrow a\cdot\mathbf{v}.
\end{align}
with a scaling factor $a$. 
This results in
\begin{align}
T_0 = \frac{1}{k_\mathrm{B}DN}\sum_{i=1}^{N}\frac{m}{2}\left(a\cdot\mathbf{v}\right)^2 =a^2\cdot \frac{1}{k_\mathrm{B}DN}\sum_{i=1}^{N}\frac{m}{2}\mathbf{v}^2 = a^2\cdot T(t).
\end{align}
We can identify the scaling factor $a$ as
\begin{align}
a = \sqrt{\frac{T_0}{T(t)}}.
\end{align}

\section{Setting up and Warming up the System}
\section{Radial Distribution Function}
To calculate the radial distribution function at a given time, the following function was implemented:
\begin{lstlisting}
def rdf(self):
    r = np.linalg.norm(self.r_ij_matrix, axis=2)
    hist, bins = np.histogram(r, bins=100, range=(0.8, 5))
    return hist, bins
\end{lstlisting}
First, the distances are calculated from the matrix of distance vectors. 


\section{Measuring Equilibrium Mean Values of the Observables}
\section{Tail Correction in the Pressure Calculation}
The pressure for a system in $d$ dimensions with volume $V$ can be calculated using the expression
\begin{align}
P = \underbrace{\frac{Nk_\mathrm{B}T}{V}}_{\text{ideal gas contribution}} + \underbrace{\frac{1}{dV}\sum_{i<j}\langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle}_{\text{virial contribution}}.
\end{align}
We can split this expression into a part that corresponds to the system with truncated potentials and a correction $\Delta P$:
\begin{align}
P = \underbrace{\frac{Nk_\mathrm{B}T}{V} + \frac{1}{dV}\sum_{\substack{i<j\\ r_{ij}<r_\mathrm{c}}}\langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle}_{P_\text{truncated}} + \underbrace{\frac{1}{dV}\sum_{\substack{i<j\\ r_{ij}>r_\mathrm{c}}}\langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle}_{\Delta P}.
\end{align}
This leads to the expression
\begin{align}
\Delta P = \frac{1}{3V}\sum_{\substack{i<j\\ r_{ij}>r_\mathrm{c}}}\langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle
\end{align}
for a system in 3 dimensions. The average $\langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle$ can in general be calculatedusing the appropriate statistical mechanical distribution function (for example the Boltzmann distribution for the canonical ensemble). Using the simplifying assumption that the particle density $\rho\left(\mathbf{r}\right)$ is constant and given by 
\begin{align}
\rho\left(\mathbf{r}\right) = \frac{N}{V}
\end{align}
we can explicitly calculate $\langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle$:
\begin{align}
\begin{split}
\langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle_{r_{ij}>r_\mathrm{c}} &\approx \frac{\rho}{N}\iiint_{V\setminus B_{r_\mathrm{c}}(0)}\mathrm{d}^3r_{ij}\,\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}= \frac{1}{V}\iiint_{V\setminus B_{r_\mathrm{c}}(0)}\mathrm{d}^3r_{ij}\,24\epsilon\left(\frac{2\sigma^{12}}{r_{ij}^{12}}-\frac{\sigma^6}{r_{ij}^6}\right)\\ &
\approx \frac{1}{V}\iiint_{\mathbb{R}^3\setminus B_{r_\mathrm{c}}(0)}\mathrm{d}^3r_{ij}\,24\epsilon\left(\frac{2\sigma^{12}}{r_{ij}^{12}}-\frac{\sigma^6}{r_{ij}^6}\right)= \frac{96\pi\epsilon}{V}\int_{r_\mathrm{c}}^{\infty}\mathrm{d}r_{ij}\,r_{ij}^2\left(\frac{2\sigma^{12}}{r_{ij}^{12}}-\frac{\sigma^6}{r_{ij}^6}\right)\\ &= \frac{96\pi\epsilon\sigma^3}{3V}\left(\frac{2}{3}\left(\frac{\sigma}{r_\mathrm{c}}\right)^9-\left(\frac{\sigma}{r_\mathrm{c}}\right)^3\right)
\end{split}
\end{align}
In the third step we extended the range of integration over $\mathbb{R}^3\setminus B_{r_\mathrm{c}}(0)$, this is approximately equal to the integral over $V\setminus B_{r_\mathrm{c}}(0)$ because the integrand goes to zero like $r_{ij}^{-4}$ as $r_{ij}\rightarrow\infty$. Plugging this expression into the formula for the tail correction results in
\begin{align}
\begin{split}
\Delta P &= \frac{1}{3V}\sum_{\substack{i<j\\ r_{ij}>r_\mathrm{c}}}\langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle = \frac{1}{3V}\cdot\frac{N(N-1)}{2}\cdot \langle\mathbf{r}_{ij}\cdot\mathbf{F}_{ij}\rangle_{r_{ij}>r_\mathrm{c}}\\
&\approx \frac{1}{3V}\cdot\frac{N(N-1)}{2}\cdot\frac{96\pi\epsilon\sigma^3}{3V}\left(\frac{2}{3}\left(\frac{\sigma}{r_\mathrm{c}}\right)^9-\left(\frac{\sigma}{r_\mathrm{c}}\right)^3\right)\\
&\approx \frac{16\pi\rho^2\epsilon\sigma^3}{3}\left(\frac{2}{3}\left(\frac{\sigma}{r_\mathrm{c}}\right)^9-\left(\frac{\sigma}{r_\mathrm{c}}\right)^3\right).
\end{split}
\end{align}
In the third step we made use of the approximation $N(N-1)\approx N^2$ for large $N$.




\end{document}
